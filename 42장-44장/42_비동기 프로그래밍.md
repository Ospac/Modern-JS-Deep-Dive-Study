# 42장 비동기 프로그래밍
## 42.1 동기 처리와 비동기 처리

함수의 실행 순서는 실행 컨텍스트 스택으로 관리한다. 자바스크립트 엔진은 단 하나의 실행 컨텍스트 스택을 갖고, 한번에 하나의 함수를 실행할 수 있다.
이처럼 자바스크립트 엔진은 **싱글 스레드**<sup>single thread</sup> 방식으로 동작한다.
- 처리에 시간이 걸리는 태스크를 실행하는 경우 블로킹<sup>blocking</sup>(작업 중단)이 발생한다.

현재 실행 중인 태스크가 종료할 때까지 다음에 실행될 태스크가 대기하는 방식을 **동기**<sup>synchronous</sup> 처리 라고한다.
- 실행 순서가 보장된다.
- 이후 태스크들이 블로킹된다.

<img width="776" height="260" alt="42-2" src="https://github.com/user-attachments/assets/6b41d55f-fa25-439f-82c9-6d24f62bcfc8" />


현재 실행 중인 태스크가 종료되지 않은 상태라도 다음 태스크를 곧바로 실행하는 방식을 **비동기**<sup>asynchronous</sup> 처리 라고 한다.
- `setTimeout`, `setInterval`, HTTP 요청, 이벤트 핸들러등은 비동기로 동작함
- 실행 순서가 보장되지 않는다.
- 콜백 패턴을 사용한다.
	- 남용할 경우, 콜백 헬로 인한 가독성 이슈가 있다.
	- 비동기 코드 동작 중 에러의 예외 관리가 필요하다.

```js
function foo() {
  console.log('foo');
}

function bar() {
  console.log('bar');
}

// 타이머 함수 setTimeout은 일정 시간이 경과한 이후에 콜백 함수 foo를 호출한다.
// 타이머 함수 setTimeout은 bar 함수를 블로킹하지 않는다.
setTimeout(foo, 3 * 1000);
bar();
// bar 호출 -> (3초 경과 후) foo 호출
```
<img width="742" height="238" alt="42-3" src="https://github.com/user-attachments/assets/7faebb3b-8751-4260-93b0-45f368dc1656" />

## 42.2 이벤트 루프와 태스크 큐
있ㄴ
자바스크립트는 싱글 스레드로 동작하지만, 여러 태스크를 동시에 처리에 하는 것처럼 보인다. 비동기 방식으로 동작하는 **이벤트 루프**는 이러한 자바스크립트의 동시성<sup>concurrency</sup>를 지원한다.

<img width="334" height="289" alt="42-4" src="https://github.com/user-attachments/assets/61939c42-9583-4829-9bcf-7694b9bddfd6" />

대부분의 자바스크립트 엔진은 크게 2가지 영역으로 구분된다.
- 콜 스택 <sup>call stack</sup>
	-  실행 컨텍스트 스택을 가리킨다. 
	- 함수를 호출하면 함수 실행 컨텍스트가 순차적으로 콜 스택에 푸시되어 실행된다.
	- JS 엔진은 하나의 콜 스택을 사용하기에 현재 실행중인 실행 컨텍스트가 종료되어 콜 스택에서 제거되기 전에는 다른 태스크를 실행하지 않는다.
- 힙 <sup>heap</sup>
	- 객체가 저장되는 메모리 공간, 실행 컨텍스트에서 힙에 저장된 객체를 참조한다.
	- 객체를 할당하는 메모리 공간을 런타임에 결정(동적 할당)한다.
JS 엔진은 태스크가 요청되면 콜 스택을 통해 요청된 작업을 순차적으로 실행한다.

따라서, 동기 처리는 JS 엔진에서**비동기 처리는 JS 엔진의 환경인 브라우저 또는 Node.js가 담당한다.** 
이를 위해 브라우저 환경은 태스크 큐, 이벤트 루프를 제공한다.
- 태스크 큐<sup>task queue/event queue/callback queue</sup>
	- 비동기 함수의 콜백 함수, 이벤트 핸들러가 일시적으로 보관되는 영역
	- 프로미스의 후속처리 메서드의 콜백이 보관되는 마이크로 태스크 큐도 존재(45.7)
- 이벤트 루프 <sup>event loop</sup>
	- 태스크 큐를 이용하여 비동기 처리를 관리한다.
	- 콜 스택에 현재 실행중인 실행 컨텍스트가 있는지, 태스크 큐에 대기중인 함수가 있는지 반복해서 확인
	- 콜 스택이 비어있고 태스크 큐에 대기중인 함수가 있다면, 순차적으로<sup>FIFO, First In First out</sup> 태스크 큐에 대기중인 함수를 콜 스택으로 이동시키는 역할


### 예시
```js
function foo() {
  console.log('foo');
}

function bar() {
  console.log('bar');
}

setTimeout(foo, 0); // 0초(실제는 4ms) 후에 foo 함수가 호출된다.
bar();
```
#### JS 엔진과 브라우저 관점에서 보는 실행 과정
1. 전역 실행 컨텍스트 생성, 콜 스택 푸시
2. 전역 코드 실행, `setTimeout` 함수 호출, `setTimeout`의 함수 실행 컨텍스트가 생성되고 콜 스택에 푸시, 함수 코드 실행
3. `setTimeout`이 실행되면 콜백 함수 `foo`를 호출 스케줄링하고 종료 및 콜 스택에서 팝
4. 브라우저와 JS 엔진의 동시 처리
	4.1. 브라우저는 3에서 스케줄링한 타이머의 지연 시간 or 최소 지연 시간(4ms) 가 만료되면 콜백 함수 `foo`를 태스크 큐에 푸시
	4.2. JS 엔진은 `bar` 함수를 호출하고 `bar` 함수의 함수 실행 컨텍스트 생성, 콜 스택에 푸시 후 실행, `bar`가 종료되면 콜 스택에서 팝
5. 전역 코드 실행 종료, 전역 실행 컨텍스트가 콜 스택에서 팝
6. 브라우저의 이벤트 루프가 콜 스택이 비어 있음을 확인하고, 태스크 큐에 있는 콜백 함수 `foo`를 콜 스택에 푸시, 
	- 함수 실행 컨텍스트 생성, 실행, 함수 종료 후 콜 스택에서 팝


#### 결론
 자바스크립트는 싱글 스레드 방식으로 동작하지만, 브라우저는 멀티 스레드로 동작하기 때문에, 비동기 동작을 처리할 수 있는 것이다.
- 브라우저는 JS 엔진외에도 렌더링 엔진, WebAPI를 제공한다. (DOM API, 타이머 함수, HTTP 요청 포함)


